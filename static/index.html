<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>EduAuth MFA Demo</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    form { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #ccc; }
    input, button, textarea { display: block; width: 100%; margin-bottom: .5rem; }
    code { background: #eee; padding: .5rem; display: block; word-break: break-all; }
  </style>
</head>
<body>
  <h1>EduAuth-MFA Demo</h1>

  <form id="form-register"><h2>1. Registro</h2>
    <input name="email" placeholder="Email" required>
    <input name="password" type="password" placeholder="Contraseña" required>
    <button>Registrar</button><pre id="out-register"></pre></form>

  <form id="form-login"><h2>2. Login</h2>
    <input name="email" placeholder="Email" required>
    <input name="password" type="password" placeholder="Contraseña" required>
    <button>Login</button><pre id="out-login"></pre></form>

  <form id="form-setup-mfa"><h2>3. Setup MFA</h2>
    <input name="email" placeholder="Email" required>
    <button>Generar QR</button>
    <img id="qr-img" alt="QR TOTP" style="display:block; margin:1rem 0; max-width:200px;">
    <pre id="out-setup-mfa"></pre></form>

  <form id="form-verify-mfa"><h2>4. Verificar MFA</h2>
    <input name="email" placeholder="Email" required>
    <input name="code" placeholder="Código TOTP" required>
    <button>Activar MFA</button><pre id="out-verify-mfa"></pre></form>

  <form id="form-login-mfa"><h2>5. Login MFA</h2>
    <input name="email" placeholder="Email" required>
    <input name="code" placeholder="Código TOTP" required>
    <button>Login MFA</button>
    <pre id="out-login-mfa"></pre>
    <code id="token-box" style="display: none;"></code>
  </form>

  <form id="form-profile"><h2>6. Perfil</h2>
    <input name="token" placeholder="Bearer &lt;TOKEN&gt;" required>
    <button>Ver Perfil</button><pre id="out-profile"></pre></form>

  <script>
    const API = window.location.origin;

    async function call(endpoint, data, opts = {}) {
      const res = await fetch(API + endpoint, {
        method: opts.method || 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(opts.auth ? { 'Authorization': opts.auth } : {})
        },
        body: ['GET'].includes(opts.method) ? null : JSON.stringify(data)
      });
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return txt; }
    }

    document.getElementById('form-register').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/auth/register', { email:f.email.value, password:f.password.value });
      document.getElementById('out-register').innerText = JSON.stringify(out, null, 2);
    };

    document.getElementById('form-login').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/auth/login', { email:f.email.value, password:f.password.value });
      document.getElementById('out-login').innerText = JSON.stringify(out, null, 2);
    };

    document.getElementById('form-setup-mfa').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/auth/setup-mfa', { email:f.email.value });
      document.getElementById('qr-img').src = out.qr_code || '';
      document.getElementById('out-setup-mfa').innerText = JSON.stringify(out, null, 2);
    };

    document.getElementById('form-verify-mfa').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/auth/verify-mfa', { email:f.email.value, code:f.code.value });
      document.getElementById('out-verify-mfa').innerText = JSON.stringify(out, null, 2);
    };

    document.getElementById('form-login-mfa').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/auth/login-mfa', { email:f.email.value, code:f.code.value });

      const outBox = document.getElementById('out-login-mfa');
      const tokenBox = document.getElementById('token-box');

      if (out.access_token) {
        const bearer = "Bearer " + out.access_token;
        outBox.innerText = "Token generado con éxito. Cópialo y pégalo en el paso 6 ↓";
        tokenBox.style.display = 'block';
        tokenBox.innerText = bearer;

        // autocompletar el campo del paso 6
        document.querySelector('#form-profile input[name="token"]').value = bearer;
      } else {
        outBox.innerText = JSON.stringify(out, null, 2);
        tokenBox.style.display = 'none';
      }
    };

    document.getElementById('form-profile').onsubmit = async e => {
      e.preventDefault();
      const f = e.target;
      const out = await call('/user/profile', {}, { method:'GET', auth:f.token.value });
      document.getElementById('out-profile').innerText = JSON.stringify(out, null, 2);
    };
  </script>
</body>
</html>
